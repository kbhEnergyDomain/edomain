<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>ESRI demo</title>
<script
  src="https://code.jquery.com/jquery-3.4.1.js"
  integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
  crossorigin="anonymous"></script>
  <script
  src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"
  integrity="sha256-T0Vest3yCU7pafRw9r+settMBX6JkKN06dqBnpQ8d30="
  crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.min.js"></script>

<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

<!-- 	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script> -->
    <link rel="stylesheet" href="https://js.arcgis.com/4.11/esri/themes/light/main.css"  />
    <style>
      html,
      body,
      #viewDiv {

        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
      #titleDiv {
        padding: 10px;
      }

      #titleText {
        font-size: 20pt;
        font-weight: 60;
        padding-bottom: 10px;
      }

.chart-container { 
display: inline;
float: left;
width: 50%;
height: 25%;
}

	  .chart-type { 
		display: inline;
		float: left; 

	   }


  #jqSlider {
    position: absolute;
    left: 2em; /* 32 pixels */
    top: 15.65em; /* 250 pixels */
    height: 12.5em; /* 200 pixels */
    z-index: 2;
    font-size: 0.75em; /* 12 pixels */
  }

    </style>
 
    <script src="https://js.arcgis.com/4.11/"></script>
    <!-- KUr%9TW43mA@RVvaK48klX3M2Rfnumkr -->

</head>
 <body>

  <section class="bg-light">
        <div class="container">
          <div class="row"> 
            <div class="col-lg-8">
               <div id="viewDiv" ></div>
                <div id="titleDiv" class="esri-widget">
                <div id="titleText">Well Locations</div>
                <div>Extracted from Mineral Ware Database </div>
              </div>
             </div>
          <div class="col-lg-4">
              <button id="demo" class="chart-type"  onclick="myFunction()">Click me</button>
              <canvas id="producers-chart" class="chart-type" height="250" width="300"></canvas>
              <canvas id="permits-chart" class="chart-type" height="250" width="300"></canvas>
              <canvas id="production-chart" class="chart-type" width="500" height="350"></canvas>
         </div>
       </div>
     </div>
   </section>
  </body>



    <script>



      //------------------------------


      // ------------------------------

    var full_map; 
    var full_view; 
    var producerChart;
    var permitsChart;
    var productionChart; 

    var wells_producing = { } ;  //  1
    var wells_plugged   = { } ;  // 11 or 13
    var wells_dry       = { } ;  //  4
    var wells_other     = { } ;	 // all else up to 16
    var wells_gas       = { } ;  // 2
    var permit_count    = { } ;
    var permitChartData = { } ; 
    var producerChartData = { }; 
    var list_of_apis    = { } ; 

      require([
      	"esri/Map",
      	//"dojo/on",
        "esri/views/MapView",
        "esri/layers/FeatureLayer",
        "esri/widgets/Search",
        "esri/WebMap",
        "esri/Graphic",
        "esri/Color",
        "esri/geometry/Circle",
        "esri/symbols/SimpleMarkerSymbol", 
        "esri/symbols/SimpleLineSymbol", "esri/symbols/SimpleFillSymbol", "esri/renderers/SimpleRenderer",
        "esri/widgets/Legend",
        "esri/widgets/Expand",
        "esri/widgets/Bookmarks",
        "esri/core/lang",
        "esri/tasks/support/Query",
        "esri/core/promiseUtils",
        "esri/core/watchUtils"
      ], function(
      	Map, 
      	// on,
        MapView,
        FeatureLayer,
        Search, 
        WebMap,
        Graphic,
        Color, 
        Circle,
        SimpleMarkerSymbol,
        SimpleLineSymbol, SimpleFillSymbol, SimpleRenderer,
        Legend,
        Expand,
        Bookmarks,
        lang,
        Query,
        promiseUtils,
        watchUtils
      ) {
      	// Core map functionality here. 

   		var map = new Map({
          basemap: "streets"
        });



   		full_map = map; 

        var view = new MapView({
          container: "viewDiv",
          map: map,
          zoom: 12,
          center: [-100, 31] // longitude, latitude
        });
		//  https://services9.arcgis.com/wpAdAylFiNhHWMxM/arcgis/rest/services/All_MineralWare_Wells/FeatureServer
		full_view = view; 
		 var featureLayer = new FeatureLayer({
          url:
            "https://services9.arcgis.com/wpAdAylFiNhHWMxM/arcgis/rest/services/All_MineralWare_Wells/FeatureServer/0",
          outFields:['operator_name']
        });


        var well_head_symbol = {
			  type: "simple-marker",  // autocasts as new SimpleMarkerSymbol()
			  style: "triangle",
			  color: "blue",
			  size: "8px",  // pixels
			  outline: {  // autocasts as new SimpleLineSymbol()
			    color: [ 247, 34, 0 ],
			    width: 1  // points
			  }
			};


		var circle_symbol = {
			  type: "simple-fill",  // autocasts as new SimpleFillSymbol()
			  color: [ 251,51, 204, 0.9 ],
			  style: "cross",
			  outline: {  // autocasts as new SimpleLineSymbol()
			    color: "white",
			    width: 1
			  }
			};


        featureLayer.screenSizePerspectiveEnabled = true;
		featureLayer.renderer =  {
				  type: "simple",  // autocasts as new SimpleRenderer()
				  symbol: well_head_symbol 
				} 


        map.add(featureLayer);
		view.ui.add("titleDiv", "top-right");
   
        // Adds the search widget to the top right corner of the view
        // view.ui.add(
        //   new Search({
        //     view: view
        //   }),
        //   "top-right"
        // );




        ///-------------------------------------------------------------------
        // Interactive portion here. 

        full_view.on("click", function(event){

        	 console.log("ouch", $("#producers-chart"))
			  var graphic = new Graphic({
			    geometry: event.mapPoint,
			    symbol: {
			      type: "simple-marker", // autocasts as new SimpleMarkerSymbol()
			      color: "blue",
			      size: 8,
			      outline: { // autocasts as new SimpleLineSymbol()
			        width: 0.5,
			        color: "darkblue"
			      }
			    }
			  });
			  var circle  = new Circle ({
 				center: event.mapPoint,

				geodesic: true,
     			radius: 3,
     			radiusUnit: "miles",
			   
				
			  }); 

			  var fillSymbol = {
					type: "simple-fill", // autocasts as new SimpleFillSymbol()
					color: [227, 139, 79, 0.8],
					outline: { // autocasts as new SimpleLineSymbol()
					color: [255, 255, 255],
					width: 1
					}
				};
			var polygonGraphic = new Graphic({
				geometry: circle,
				symbol: fillSymbol
				});
			//console.log(circle.rings, circle)

			full_view.graphics.removeAll()

			full_view.graphics.add(graphic);
			full_view.graphics.add(polygonGraphic);

			var template = {
 			 // autocasts as new PopupTemplate()
  				title: "{well_name} : {permit_num}",


  				content: [
						    {
						      type: "fields",
						      fieldInfos: [
						        {
						          fieldName: "operator_name",
						          label: "Operator Name"
						        },
						        {
						          fieldName: "permit_num",
						          label: "Permit"
						        },
						        {
						          fieldName: "status_type_id",
						          label: "Type"
						        },
						        {
						          fieldName:  'depth',
						          label: "Depth"
						        }
						      ]
						    }
						  ]
  			}

  			featureLayer.popupTemplate = template; 

			var query = featureLayer.createQuery();
			//query.where = "operator_name is not null";
			query.outFields = [ "operator_name" , "well_name" , "status_type_id", "permit_num", "depth", "api"];
			query.geometry = polygonGraphic.geometry;
			query.spatialRelationship = "intersects";  // this is the default
			query.returnGeometry = true;
 			featureLayer.queryFeatures(query).then(function(response) { 
		       
		        var features = response.features;
		        var inBuffer = [];

			    wells_producing = { } ;  //  1
	        	wells_plugged   = { } ;  // 11
	       		wells_dry       = { } ;  //  4
	       		wells_other     = { }
	       		wells_gas       = { } 
	       		permit_count    = { } 
            list_of_apis    = { } 


		        console.log(" Length of features = ", features, response)

			    for (var x = 0; x < features.length; x++) {
			            //popTotal = popTotal + 1; //features[x].attributes["POP2000"];
                  var api = features[x].attributes['api']
			            var opn = features[x].attributes['operator_name'];
			            var stx = features[x].attributes['status_type_id'];
			            var pnum = features[x].attributes['permit_num'];
			            //console.log( x, features[x].attributes['operator_name']," -> ", features[x].attributes['permit_num'],
			            // 		features[x].attributes['well_name'], features[x].attributes['status_type_id'], )

                  list_of_apis[api] = 1; 

			            if (stx == 1 ) {
			            	if (!(opn in wells_producing)) {
			            		wells_producing[opn] = 1; 
			            	} else { 
			            		wells_producing[opn] = wells_producing[opn] + 1; 
			            	}
			            }
			            else if (stx == 4 ) {
			            	if (!(opn in wells_dry)) {
			            		wells_dry[opn] = 1; 
			            	} else { 
			            		wells_dry[opn] = wells_dry[opn] + 1; 
			            	}
			            }
			            else if (stx == 11 || stx == 13 ) {
			            	if (!(opn in wells_plugged)) {
			            		wells_plugged[opn] = 1; 
			            	} else { 
			            		wells_plugged[opn] = wells_plugged[opn] + 1; 
			            	}
			            }
			            else if (stx == 2) {
			            	if (!(opn in wells_gas)) {
			            		wells_gas[opn] = 1; 
			            	} else { 
			            		wells_gas[opn] = wells_gas[opn] + 1; 
			            	}
			            }
			            else {
			            	if (!(opn in wells_other)) {
			            		wells_other[opn] = 1; 
			            	} else { 
			            		wells_other[opn] = wells_other[opn] + 1; 
			            	}
			            }
			            	
			            if (!(opn in permit_count)) {
			            		permit_count[opn] = 1; 
			            	} else { 
			            		permit_count[opn] = permit_count[opn] + 1; 
			            	}

			        }
			 //    console.log(wells_producing);
			 //    console.log(wells_dry);
			 //    console.log(wells_plugged);
				// console.log(wells_gas);
				// console.log(wells_other);
				// console.log(permit_count);

				makeDataForChart( wells_producing, producerChart ) 
				makeDataForChart( permit_count, permitsChart ) 
        makeDataForLineChart( list_of_apis, productionChart)
				
 				});

 			// Once the map is created 
 			

			});



		$(document).ready(createCharts); 
		//createCharts();

    function makeDataForLineChart(api_dict, thechart){
        console.log("List of Apis " , api_dict, Object.keys(api_dict));


        $.ajax({
            type: "POST",
            crossDomain: true,
            url: "{% url 'getProductionPayments'  %}",
            // url : '/api/getProductionPayments/',
            data: {'arr':  Object.keys(api_dict)},
            // contentType: "application/json; charset=utf-8",  
            // dataType: "jsonp",
            headers: {"X-CSRFToken":'{{ csrf_token }}'},
            success: function (result) {
                console.log("SUCCESS")
                console.log(result);
            },
            error: function (result) {
               console.log("FAILURE")
                console.log(result);
            }
            });
      }


    function makeDataForChart(wpr, thechart ) { 
			//var wpr = wells_producing; 
         	//console.log(".... making data ... ", wpr)
         	var mylabels = Object.keys(wpr);
         	var myvalues = Object.values(wpr);
    			console.log(myvalues, mylabels);
    			thechart.data.labels = mylabels; 
    			thechart.data.datasets[0].data = myvalues; 
    			thechart.update() 

        }




	    function createCharts( data ) { 
	       console.log("Creating", $("#producers-chart"));
	    

         const producerCanvas = document.getElementById("producers-chart");
         
         
         producerChart = new Chart(producerCanvas.getContext("2d"), {
            type: "bar",
            data: { 
              labels: ["a","b","c"], //keys(wells_producing),
              datasets: [
                {
                  label: "Producing wells ",
                  backgroundColor: "#149dcf",
                  //
                  data: [ 2, 3,4 ], // values(wells_producing),
                },
              ]
            },
            options: {
            	responsive: false, 
            	maintainAspectRatio: false, 
                legend: { display: true },
			      title: {
			        display: false,
			        text: 'Producing'
			      },

				scales: {
        			yAxes: [{
            			ticks: {
                		beginAtZero:true
            				}
				        }]
				    }
            	}
          });

         const permitsCanvas = document.getElementById("permits-chart");
         
         permitsChart = new Chart(permitsCanvas.getContext("2d"), {
            type: "bar",
            data: { 
              labels: ["a","b","c"], //keys(wells_producing),
              datasets: [
                {
                  label: "Number of Permits",
                  backgroundColor: "red",
                  //
                  data: [ 2, 3,4,5 ], // values(wells_producing),
                },
              ]
            },
            options: {
            	responsive: false, 
            	maintainAspectRatio: false, 
                legend: { display: true },
			      title: {
			        display: false,
			        text: 'Permits'
			      },

				scales: {
        			yAxes: [{
            			ticks: {
                		beginAtZero:true
            				}
				        }]
				    }
            	}
          });

         console.log("Created charts.....")
         ctx = document.getElementById("production-chart").getContext('2d');
         console.log(".....", ctx)
                var s1 = {
                    label: 's1',
                    borderColor: 'blue',
                    data: [
                        {'x': '2015-03-01', 'y': 12},
                         {'x': '2015-04-01', 'y': 62},
                         {'x': '2015-05-01', 'y': 5},
                         {'x': '2015-06-01', 'y': 0},
                         {'x': '2015-07-01', 'y': 150},
                         {'x': '2015-08-01', 'y': 359},
                         {'x': '2015-09-01', 'y': 102},
                         {'x': '2015-10-01', 'y': 5},
                         {'x': '2015-11-01', 'y': 85},
                         {'x': '2015-12-01', 'y': 57},
                         {'x': '2016-01-01', 'y': 394},
                         {'x': '2016-02-01', 'y': 387},
                         {'x': '2016-03-01', 'y': 327},
                         {'x': '2016-04-01', 'y': 307},
                         {'x': '2016-05-01', 'y': 300},
                         {'x': '2016-06-01', 'y': 111},
                         {'x': '2016-07-01', 'y': 30},
                         {'x': '2016-08-01', 'y': 199},
                         {'x': '2016-09-01', 'y': 0},
                         {'x': '2016-10-01', 'y': 0},
                         {'x': '2016-11-01', 'y': 0},
                         {'x': '2016-12-01', 'y': 0},
                         {'x': '2017-01-01', 'y': 0},
                         {'x': '2017-02-01', 'y': 0},
                         {'x': '2017-03-01', 'y': 0},
                         {'x': '2017-04-01', 'y': 0},
                         {'x': '2017-05-01', 'y': 0},
                         {'x': '2017-06-01', 'y': 0},
                         {'x': '2017-07-01', 'y': 0},
                         {'x': '2017-08-01', 'y': 0},
                         {'x': '2017-09-01', 'y': 0},
                         {'x': '2017-10-01', 'y': 8},
                         {'x': '2017-11-01', 'y': 0},
                         {'x': '2017-12-01', 'y': 0},
                         {'x': '2018-01-01', 'y': 0},
                         {'x': '2018-02-01', 'y': 18},
                         {'x': '2018-03-01', 'y': 114},
                         {'x': '2018-04-01', 'y': 121},
                         {'x': '2018-05-01', 'y': 2},
                         {'x': '2018-06-01', 'y': 175},
                         {'x': '2018-07-01', 'y': 281},
                         {'x': '2018-08-01', 'y': 352},
                         {'x': '2018-09-01', 'y': 33},
                         {'x': '2018-10-01', 'y': 138},
                         {'x': '2018-11-01', 'y': 385},
                         {'x': '2018-12-01', 'y': 276},
                         {'x': '2019-01-01', 'y': 18},
                         {'x': '2019-02-01', 'y': 80},
                    ]
                  };

                  var s2 = {
                    label: 's2',
                    borderColor: 'red',
                    data: [
                        {'x': '2015-03-01', 'y': 4655},
                         {'x': '2015-04-01', 'y': 4775},
                         {'x': '2015-05-01', 'y': 2226},
                         {'x': '2015-06-01', 'y': 1649},
                         {'x': '2015-07-01', 'y': 3735},
                         {'x': '2015-08-01', 'y': 4127},
                         {'x': '2015-09-01', 'y': 4231},
                         {'x': '2015-10-01', 'y': 4232},
                         {'x': '2015-11-01', 'y': 3816},
                         {'x': '2015-12-01', 'y': 1519},
                         {'x': '2016-01-01', 'y': 3138},
                         {'x': '2016-02-01', 'y': 4118},
                         {'x': '2016-03-01', 'y': 2411},
                         {'x': '2016-04-01', 'y': 3679},
                         {'x': '2016-05-01', 'y': 3180},
                         {'x': '2016-06-01', 'y': 4386},
                         {'x': '2016-07-01', 'y': 3940},
                         {'x': '2016-08-01', 'y': 3876},
                         {'x': '2016-09-01', 'y': 3793},
                         {'x': '2016-10-01', 'y': 4037},
                         {'x': '2016-11-01', 'y': 4044},
                         {'x': '2016-12-01', 'y': 3950},
                         {'x': '2017-01-01', 'y': 3155},
                         {'x': '2017-02-01', 'y': 2703},
                         {'x': '2017-03-01', 'y': 3311},
                         {'x': '2017-04-01', 'y': 2857},
                         {'x': '2017-05-01', 'y': 3343},
                         {'x': '2017-06-01', 'y': 2703},
                         {'x': '2017-07-01', 'y': 3160},
                         {'x': '2017-08-01', 'y': 3272},
                         {'x': '2017-09-01', 'y': 3249},
                         {'x': '2017-10-01', 'y': 3634},
                         {'x': '2017-11-01', 'y': 3401},
                         {'x': '2017-12-01', 'y': 3953},
                         {'x': '2018-01-01', 'y': 3601},
                         {'x': '2018-02-01', 'y': 2963},
                         {'x': '2018-03-01', 'y': 2997},
                         {'x': '2018-04-01', 'y': 3282},
                         {'x': '2018-05-01', 'y': 3367},
                         {'x': '2018-06-01', 'y': 3289},
                         {'x': '2018-07-01', 'y': 3101},
                         {'x': '2018-08-01', 'y': 3403},
                         {'x': '2018-09-01', 'y': 2976},
                         {'x': '2018-10-01', 'y': 3425},
                         {'x': '2018-11-01', 'y': 2836},
                         {'x': '2018-12-01', 'y': 3196},
                         {'x': '2019-01-01', 'y': 2243},
                         {'x': '2019-02-01', 'y': 3106},
                         {'x': '2019-03-01', 'y': 3079},
                         
                                            ]
                  };


                  ctx = document.getElementById("production-chart").getContext('2d');

                  productionChart = new Chart(ctx, {
                    type: 'line',
                    data: { datasets: [s1, s2] },
                    options: {
                      scales: {
                        xAxes: [{
                          type: 'time'
                        }]
                      }
                    }
                  });

                  console.log("ctx", ctx, canvas)
	    }




        ///-------------------------------------------------------------------
  
      });  // end of require function

      function myFunction() {
     document.getElementById("demo").innerHTML = "YOU CLICKED ME!";
    var arr = [1, 2, 3, 4];
    var uuu = "{% url 'getProductionPayments'  %}"; 
    console.log(uuu)

             $.ajax({
            type: "POST",
            crossDomain: true,
            url: "{% url 'getProductionPayments'  %}",
            // url : '/api/getProductionPayments/',
            data: {'arr': arr},
            // contentType: "application/json; charset=utf-8",  
            // dataType: "jsonp",
            headers: {"X-CSRFToken":'{{ csrf_token }}'},
            success: function (result) {
                console.log("SUCCESS")
                console.log(result);
            },
            error: function (result) {
               console.log("FAILURE")
                console.log(result);
            }
            });

    }


    </script>

</html>